import React, { useState, useEffect, useContext } from "react";
import { useNavigate } from "react-router-dom";
import { GameContext } from "../context/GameContext";
import { FaGift, FaHome } from "react-icons/fa";
import Confetti from "react-confetti";
import "../App.css";

function GamePage() {
  const { currentIndex } = useContext(GameContext);
  const navigate = useNavigate();

  const [attempt, setAttempt] = useState(1);
  const [showAnswer, setShowAnswer] = useState(false);
  const [showWin, setShowWin] = useState(false);
  const [showLose, setShowLose] = useState(false);
  const [timeLeft, setTimeLeft] = useState(60);
  const [showConfetti, setShowConfetti] = useState(false);

  const questions = [
    {
      hints: [
        "في الفترة بين 1345 - 1346هـ/1926-1927م، أمر بتبليط المسعى بالحجر الصوان المربع، وهي أول مرة في تاريخ المسجد الحرام يُرصف فيها الطريق",
        "أصدر أمرًا بسَكِّ أول عملة معدنية، وكانت من فئة نصف القرش، وربع القرش، وتعد أول نقد سعودي خالص",
      ],
      answer: "عبدالعزيز بن عبدالرحمن آل سعود",
      img: "/assets/Q1.jpg",
    },
    {
      hints: [
        "حصد لقب أفضل لاعب سعودي في كرة السلة ست مرات",
        "دخل موسوعة جينيس للأرقام القياسية، بعدما أصبح أكبر لاعب كرة سلة في العالم (من حيث العمر) يشارك في مباريات رسمية",
      ],
      answer: "محسن خلف",
      img: "/assets/Q2.jpg",
    },
    {
      hints: [
        "لحّن الأغنية الوطنية 'بلادي منار الهدى' و 'مقادير'",
        "أوكلت إليه مهمة التوزيع الموسيقي واللحن للنشيد الوطني السعودي عام 1400هـ/1980م",
      ],
      answer: "سراج عمر",
      img: "/assets/Q3.jpg",
    },
    {
      hints: [
        "نال جائزة الملك فيصل العالمية لخدمة الإسلام عام 1433هـ/2012م",
        "أسهم في تأسيس منشأة مصرفية إسلامية كبرى تمثل نموذجًا للمصارف الإسلامية الساعية إلى الالتزام بالتعاليم الإسلامية",
      ],
      answer: "سليمان الراجحي",
      img: "/assets/Q4.jpg",
    },
    {
      hints: [
        "في عام 2002م حقق مع المنتخب السعودي كأس الخليج في الرياض",
        "يعد المدرب الوطني الوحيد الذي قاد المنتخب في نهائيات كأس العالم",
      ],
      answer: "ناصر الجوهر",
      img: "/assets/Q5.jpg",
    },
    {
      hints: [
        "هو أول وزير للمالية في تاريخ المملكة العربية السعودية",
        "كان ممثل الحكومة السعودية في مفاوضات امتياز النفط، لقَّبه الملك المؤسس بـ'رجل المهمات الصعبة'",
      ],
      answer: "عبدالله السليمان",
      img: "/assets/Q6.jpg",
    },
    {
      hints: [
        "كان من الأولويات في عهده ترميم الكعبة المشرفة، ويعد الترميم الخاص ببناء الكعبة أول ترميم منذ إعادة بنائها قبل نحو 3 قرون",
        "يعد أول أمير سعودي يذهب إلى القدس وصلى في المسجد الأقصى الشريف والمسجد الإبراهيمي في الخليل",
      ],
      answer: "سعود بن عبدالعزيز آل سعود",
      img: "/assets/Q7.jpg",
    },
    {
      hints: [
        "بطل كأس العالم للراليات الصحراوية 'باها دبي' 2022",
        "توّج بلقب رالي داكار السعودية 2025 لفئة السيارات، وهو أول متسابق سعودي يحقق هذا الإنجاز في تاريخ رالي داكار العالمي",
      ],
      answer: "يزيد الراجحي",
      img: "/assets/Q8.jpg",
    },
    {
      hints: [
        "كانت بدايته الإذاعية من خلال قراءة نشرة الأخبار في إذاعة نداء الإسلام، وأول إذاعة خارجية له عندما زار الرئيس الأمريكي ريتشارد نيكسون المملكة العربية السعودية عام 1394هـ/1974م",
        "كان المعلق الرئيس في التلفزيون السعودي على حادثة اعتداء جهيمان الإرهابية على المسجد الحرام عام 1400هـ/1979م",
      ],
      answer: "حسين نجار",
      img: "/assets/Q9.jpg",
    },
    {
      hints: [
        "هي أول امرأه سعودية تعمل في المجال الرياضي عندما دخلت عضوًا في لجنة المسؤولية الاجتماعية في الاتحاد السعودي لكرة القدم عام 2018م",
        "أسست ورأست أول ناد نسائي سعودي، كما أسهمت في تأسيس أول منتخب نسائي سعودي",
      ],
      answer: "أضواء العريفي",
      img: "/assets/Q10.jpg",
    },
    {
      hints: [
        "يعد أول لاعب سعودي يحترف في أوروبا، في نادي ايه زد ألكمار الهولندي",
        "أول لاعب سعودي يسجل في الأدوار الإقصائية لكأس العالم  لكرة القدم",
      ],
      answer: "فهد الغشيان",
      img: "/assets/Q11.jpg",
    },
    {
      hints: [
        "هي المدير العام لمركز مستقبل الفضاء وأول مهندسة صواريخ سعودية",
        "تتولى منصب نائب رئيس الاتحاد الدولي للملاحة الفضائية 'IAF'، هي مستشارة في وكالة الفضاء السعودية، وكابتن طيار",
      ],
      answer: "مشاعل الشميمري",
      img: "/assets/Q12.jpg",
    },
    {
      hints: [
        "أصدر أول بيان سياسي رسمي عن المملكة من الرياض تحت عنوان 'للحقيقة والتاريخ'، فكان بذلك أول ناطق رسمي باسم المملكة",
        "أصدر في 1385هـ/1965م مرسومًا يقضي بأن يكون اليوم الوطني للبلاد هو اليوم الذي أعلن فيه توحيد المملكة العربية السعودية، وهو الأول من الميزان من السنة الهجرية الشمسية الموافق 23 سبتمبر من السنة الميلادية",
      ],
      answer: "فيصل بن عبدالعزيز آل سعود",
      img: "/assets/Q13.jpg",
    },
    {
      hints: [
        "أحد عناصر الفريق السعودي للفروسية الذي حقق برونزية الفرق خلال الأولمبياد العالمي في لندن 2012م",
        "حقق الميدالية الفضية في المنافسات الفردية في كأس العالم لقفز الحواجز 2010م",
      ],
      answer: "عبدالله شربتلي",
      img: "/assets/Q14.jpg",
    },
    {
      hints: [
        "هو مؤلف أغنية العيد الشهيرة 'من العايدين' التي تُعد من أقدم أغاني الفرح السعودية",
        "اختير ليكون مؤلف كلمات النشيد الوطني السعودي في عهد الملك فهد بن عبدالعزيز آل سعود",
      ],
      answer: "إبراهيم خفاجي",
      img: "/assets/Q15.jpg",
    },
    {
      hints: [
        "أحد أعضاء طاقم الرحلة AX-2 لمحطة الفضاء الدولية، التي تعد ثاني مهمة رواد فضاء مخصصة إلى محطة الفضاء الدولية (ISS)",
        "أوَّل رائدة فضاء سعودية وعربية مسلمة تمثل المملكة العربية السعودية في قطاع الفضاء",
      ],
      answer: "ريانة برناوي",
      img: "/assets/Q16.jpg",
    },
    {
      hints: [
        "حقق جميع ألقاب البطولات المحلية مع ناديه",
        "قاد المنتخب في عدد من المحافل الرياضية العالمية، ومنها: الفوز بكأس آسيا في عام 1996م، كما شارك في بطولة كأس العالم عام 1998م بفرنسا",
      ],
      answer: "يوسف الثنيان",
      img: "/assets/Q17.jpg",
    },
    {
      hints: [
        "عُين مديرًا عامًّا لوكالة الأنباء السعودية 1406هـ/1986م",
        "عُين مديرًا عامًا للإذاعة السعودية عام 1400هـ/1980م",
      ],
      answer: "بدر كريم",
      img: "/assets/Q18.jpg",
    },
    {
      hints: [
        "افتتح في عهده مصنع كسوة الكعبة (مجمع الملك عبدالعزيز لكسوة الكعبة المشرفة حاليًّا)، في حي أم الجود بمكة المكرمة في 1397هـ/1977م",
        "في عهده أنشأت الرئاسة العامة لشؤون المسجد الحرام والمسجد النبوي (الهيئة العامة للعناية بشؤون المسجد الحرام والمسجد النبوي حاليًا) 'إدارة سقيا زمزم' لتتولى الإشراف على خدمات سقيا زمزم",
      ],
      answer: "خالد بن عبدالعزيز آل سعود",
      img: "/assets/Q19.jpg",
    },
    {
      hints: [
        "لاعبة تايكوندو سعودية، بطلة العرب، وأول سعودية تحصل على ميدالية برونزية آسيوية، وأفضل لاعبة عربية وسعودية عام 1444هـ/2022م",
        "تشرفت برفع علم بعثة السعودية المشاركة في أولمبياد باريس 2024 بعد اختيارها من اللجنة الأولمبية السعودية",
      ],
      answer: "دنيا أبو طالب",
      img: "/assets/Q20.jpg",
    },
    {
      hints: [
        "هو شاعر سعودي من رواد شعر النظم والمحاورة والعرضة في المملكة العربية السعودية",
        "يجيد شعر العرضة الجنوبية، وقال عنه الأمير خالد الفيصل إنه 'شاعر الوصف' أو 'ملك الوصف'",
      ],
      answer: "سعد بن جدلان",
      img: "/assets/Q21.jpg",
    },
    {
      hints: [
        "يُعد أول لاعب خليجي يسجل خمسة أهداف في لقاء واحد ببطولة الخليج أمام قطر عام 1979م، واللاعب الوحيد الذي سجل في خمس بطولات خليجية متتالية للمنتخبات",
        "حصل على لقب هداف الدوري السعودي ست مرات",
      ],
      answer: "ماجد عبدالله",
      img: "/assets/Q22.jpg",
    },
    {
      hints: [
        "عمل وزيرًا للصحة وعُيِّن مديرًا عامًّا للإذاعة والصحافة والنشر وأمينًا عامًّا لمجلس دول التعاون الخليجي",
        "أول وزير للإعلام في المملكة العربية السعودية",
      ],
      answer: "جميل الحجيلان",
      img: "/assets/Q23.jpg",
    },
    {
      hints: [
        "قدم العديد من البرامج التلفزيونية، ومنها: برنامج 'مع الناس' الذي استمر بثه لمدة 25 عامًا",
        "يُعد من أبرز الإعلاميين مرورًا على التلفزيون السعودي، واشتهر بإذاعة الأوامر الملكية والأخبار المُهمة",
      ],
      answer: "سليمان العيسى",
      img: "/assets/Q24.jpg",
    },
    {
      hints: [
        "أنشأ أول جامعة سعودية وهي جامعة الملك سعود عام 1377هـ/1957م",
        "أمر في عام 1406هـ/1986م بتبليط سطح التوسعة السعودية الأولى في المسجد الحرام بالرخام البارد المقاوم للحرارة لتهيئته للمصلين",
      ],
      answer: "فهد بن عبدالعزيز آل سعود",
      img: "/assets/Q25.jpg",
    },
    {
      hints: [
        "في عام 2016 حصل على أفضل لاعب واعد في العالم في لعبة الكاراتيه",
        "حقق في أولمبياد طوكيو 2020م الميدالية الفضية",
      ],
      answer: "طارق حامدي",
      img: "/assets/Q26.jpg",
    },
    {
      hints: [
        "يُعد أحد أعمدة الصحافة في المملكة العربية السعودية",
        "أطلق عليه الملك عبدالله بن عبدالعزيز آل سعود لقب 'ملك الصحافة'",
      ],
      answer: "تركي السديري",
      img: "/assets/Q27.jpg",
    },
    {
      hints: [
        "التحق بالمنتخب السعودي الأول عام 1999م، وكانت أول مشاركة له في كأس القارات بالمكسيك، وكان يبلغ من العمر وقتها 21 عامًا",
        "استطاع تحقيق 20 بطولة مع فريقين من الدوري السعودي",
      ],
      answer: "محمد نور",
      img: "/assets/Q28.jpg",
    },
    {
      hints: [
        "شارك في وضع نظام المؤسسات في المملكة العربية السعودية، ووضع كثيرًا من القواعد والمواد لنظام وزارة الداخلية، ووضع أنظمة شؤون الأجانب والإقامة والأحوال المدنية",
        "هو أول وزير للحج والأوقاف بالمملكة العربية السعودية، 'وزارة الحج والعمرة حاليًا'، عُيّن بها حين إنشائها في عام 1381هـ/1961م، في عهد الملك سعود بن عبدالعزيز آل سعود، وأسهم خلالها في تأسيس مصنع كسوة الكعبة",
      ],
      answer: "حسين عرب",
      img: "/assets/Q29.jpg",
    },
    {
      hints: [
        "أسست بالتعاون مع وزارة التعليم برنامج التعليم الرياضي لفتيات المدارس، وشغلت منصب وكيلة التخطيط والتطوير في الهيئة العامة للرياضة",
        "أول امرأة تتولى مسؤولية اتحاد متعدد الرياضات في السعودية، من خلال ترؤسها للاتحاد السعودي للرياضة المجتمعية",
      ],
      answer: "ريما بنت بندر بن سلطان آل سعود",
      img: "/assets/Q30.jpg",
    },
    {
      hints: [
        "في عهده انطلق مشروع 'قطار المشاعر المقدسة' الذي يربط مكة المكرمة بالمشاعر المقدسة؛ منى، وعرفات، ومزدلفة",
        "يعد أول حاكم سعودي يتعاقب على ولاية عهده ثلاثة إخوة من الأمراء، كما يعد صاحب أطول فترة ولاية عهد",
      ],
      answer: "عبدالله بن عبدالعزيز آل سعود",
      img: "/assets/Q31.jpg",
    },
    {
      hints: [
        "يعد أول لاعب يحقق بطولة كأس العالم الإلكترونية في تاريخ الفيفا لمرتين متتاليتين",
        "فاز ببطولة العالم في لعبة فيفا 2018م وبطولة العالم إكس بوكس 2019م",
      ],
      answer: "مساعد الدوسري",
      img: "/assets/Q32.jpg",
    },
    {
      hints: [
        "المشرف العام على مركز الملك سلمان للإغاثة والأعمال الإنسانية",
        "طبيب وجراح سعودي، متخصص بحالات التوائم السيامية",
      ],
      answer: "عبدالله الربيعة",
      img: "/assets/Q33.jpg",
    },
    {
      hints: [
        "اختير للعب مع فريق نجوم آسيا بموسكو عام 1418هـ/1998م، ومع فريق نجوم العالم عام 1417هـ/1997م بمرسيليا",
        "استمر في الملاعب حتى اعتزل وهو في عمر الـ 43 عامًا، ويُعد أكبر لاعب يشارك في دوري أبطال آسيا",
      ],
      answer: "حسين عبدالغني",
      img: "/assets/Q34.jpg",
    },
    {
      hints: [
        "هي ممثلة ومذيعة وكاتبة سعودية، التحقت بالإذاعة السعودية في 1382هـ/1962م لتكون أول مذيعة سعودية",
        "هي أول سعودية تقف على المسرح، ومن أوائل قارئي نشرة الأخبار في إذاعة الرياض",
      ],
      answer: "مريم الغامدي",
      img: "/assets/Q35.jpg",
    },
    {
      hints: [
        "رئيس أول جمعية مهنية للمسرح والفنون الأدائية منذ عام 1443هـ/2021م",
        "هو ممثل سعودي، وتخرج من كلية الزراعة بجامعة الملك سعود",
      ],
      answer: "ناصر القصبي",
      img: "/assets/Q36.jpg",
    },
    {
      hints: [
        "حققت الميدالية الذهبية في بطولة العالم للملاكمة التايلاندية 'المواي تاي' في عام 2023م والميدالية الذهبية في بطولة الألعاب العالمية القتالية في عام 1445هـ/2023م في مدينة الرياض",
        "أول لاعبة في المنتخب السعودي لفنون القتال المختلطة وأول سعودية تنضم إلى منظمة PFL، وحققت الميدالية الذهبية في دوري المقاتلين المحترفين في منظمة PFL",
      ],
      answer: "هتان السيف",
      img: "/assets/Q37.jpg",
    },
    {
      hints: [
        "كان أول فنان سعوديٍّ سجلته جمعية المؤلفين والموسيقيين في فرنسا، وأول من حصل على الأسطوانة الذهبية",
        "انطلاقته كانت عام 1379هـ/1959م، أي عندما كان في سن 19 سنة، وتحديدًا بعد أن أُذيعت أغنيته الأولى 'وردك يا زارع الورد' في الإذاعة السعودية",
      ],
      answer: "طلال مداح",
      img: "/assets/Q38.jpg",
    },
    {
      hints: [
        "فقد الشيخ بصره وهو لم يتجاوز من عمره 14 عامًا",
        "خلال عهد الملك المؤسس عبدالعزيز بن عبدالرحمن آل سعود، كان رئيسًا للقضاة، ومفتيًا للديار السعودية بعد تأسيس دار الإفتاء بالرياض",
      ],
      answer: "محمد بن إبراهيم آل الشيخ",
      img: "/assets/Q39.jpg",
    },
    {
      hints: [
        "أول معلق رياضي في الإذاعة السعودية والتلفزيون، وكان أول معلق على مباريات المنتخب ومباريات كأس الملك وكأس العالم",
        "كان المعلق الوحيد الذي يجيد التعليق على ألعاب رياضية أخرى غير كرة القدم، ولُقب بـ'عميد المعلقين العرب'",
      ],
      answer: "زاهد قدسي",
      img: "/assets/Q40.jpg",
    },
    {
      hints: [
        "كانت الفترة التي شغل فيها منصب وزير الإعلام نقلة نوعية للتلفزيون السعودي، حيث أدخل البث الملون عام 1976م، وأنشأ قناة سعودية ثانية تبث برامجها باللغة الإنجليزية",
        "بدأ التلفزيون السعودي في عهده ببث الصلوات من الحرمين الشريفين، ونقل صلاة التراويح في شهر رمضان",
      ],
      answer: "محمد عبده يماني",
      img: "/assets/Q41.jpg",
    },
    {
      hints: [
        "يُعدُّ أول سعودي يحصل على تأهيل أكاديمي في الموسيقى العسكرية، وأول موسيقار عربي يحصد جائزة منظمة الأمم المتحدة للتربية والعلم والثقافة 'اليونسكو' للموسيقى",
        "من رواد الحركة الفنية في المملكة العربية السعودية، أدخل الموسيقى الوترية على الأغنية السعودية، يُلقب بـ'عميد الفن السعودي'",
      ],
      answer: "طارق عبدالحكيم",
      img: "/assets/Q42.jpg",
    },
    {
      hints: [
        "يعد أول لاعب سعودي يرفع العلم السعودي في الأولمبياد العالمي",
        "حصل على فضية أولمبياد سيدني في سباق 400 م حواجز وذلك كأول لاعب سعودي",
      ],
      answer: "هادي صوعان",
      img: "/assets/Q43.jpg",
    },
    {
      hints: [
        "أول وزير للصناعة والكهرباء في المملكة العربية السعودية",
        "تولى أربع وزارات، هي: الصناعة والكهرباء، ثم وزارة الصحة، ومنها إلى وزارة المياه، ثم وزارة العمل",
      ],
      answer: "غازي القصيبي",
      img: "/assets/Q44.jpg",
    },
    {
      hints: [
        "عُيّن مؤذنًا في المسجد الحرام عام 1395هـ/1975م، وكان أذانه الأول لصلاة الفجر",
        "يطلق عليه 'شيخ المؤذنين'، ولقب بـ'بلال الحرم'",
      ],
      answer: "علي ملا",
      img: "/assets/Q45.jpg",
    },
  ];
  
  

  const data = questions[currentIndex];

  // ✅ Preload برمجي لكل الصور أول ما تفتح اللعبة
  useEffect(() => {
    questions.forEach((q) => {
      const img = new Image();
      img.src = q.img;
    });
  }, []);

  useEffect(() => {
    setAttempt(1);
    setShowAnswer(false);
    setShowWin(false);
    setShowLose(false);
    setShowConfetti(false);
    setTimeLeft(60);
  }, [currentIndex]);

  useEffect(() => {
    if (showWin || showLose) return;

    if (timeLeft <= 0) {
      endLose();
      return;
    }

    const interval = setInterval(() => {
      setTimeLeft((t) => {
        if (t - 1 === 30) setAttempt(2);
        return t - 1;
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [timeLeft, showWin, showLose]);

  function reveal() {
    setShowAnswer(true);
    setShowWin(true);
    setShowConfetti(true);
  }

  function endLose() {
    setShowAnswer(true);
    setShowLose(true);
    setShowConfetti(false);
  }

  function goHome() {
    setShowConfetti(false);
    navigate("/");
  }

  return (
    <div className="game-page-wrapper" dir="rtl">
      {/* ✅ الشعارات العلوية */}
      <div className="game-logos-static">
        <img
          src="/assets/NaDayLogo.png"
          alt="شعار اليوم الوطني"
          className="logo-static"
        />
        <img
          src="/assets/pmoLogoGame.png"
          alt="شعار وزارة المالية"
          className="logo-static"
        />
      </div>

      {/* ✅ رسالة الفوز/الخسارة */}
      <div className="result-banner-wrapper">
        {showWin && (
          <div className="result-banner win-text">مبروك! إجابة صحيحة</div>
        )}
        {showLose && (
          <div className="result-banner lose-text">
            انتهى الوقت — حظ أوفر
          </div>
        )}
      </div>

      {/* ✅ الصفحة الرئيسية للعبة */}
      <div className={`game-container ${showLose ? "lose-mode" : ""}`}>
        {showConfetti && (
          <div className="confetti-wrapper">
            <Confetti numberOfPieces={500} recycle={true} />
          </div>
        )}

        <div className="cards-grid">
          {/* ✅ العمود الأيمن (التايمر + التلميحات) */}
          <div className="hints-col">
            <div className="panel timer-card">
              <div
                className={`digital-timer ${
                  timeLeft <= 10 ? "timer-danger" : ""
                }`}
              >
                {timeLeft}
              </div>
            </div>

            <section className="panel hint-card">
              <h2>{data.hints[0]}</h2>
            </section>

            {attempt >= 2 && (
              <section className="panel hint-card">
                <h2>{data.hints[1]}</h2>
              </section>
            )}
          </div>

          {/* ✅ الكرت الأوسط (الصورة) */}
          <section className="panel image-card">
            <img
              src={data.img}
              alt="من أنا؟"
              className={`game-image ${
                showAnswer ? "clear" : attempt === 1 ? "blur-heavy" : "blur-light"
              }`}
            />
            {showAnswer && <div className="answer">الإجابة: {data.answer}</div>}
          </section>

          {/* ✅ أيقونة الجائزة / الهوم */}
          <div className="reward-col">
            {!showAnswer && timeLeft > 0 && (
              <div className="gift-icon" onClick={reveal}>
                <FaGift />
              </div>
            )}
            {(showWin || showLose || timeLeft <= 0) && (
              <div className="gift-icon home-icon" onClick={goHome}>
                <FaHome />
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

export default GamePage;
